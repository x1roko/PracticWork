# Tasker
Внутренний сервис для обеспечения документооборота, созданный на ASP.NET с использованием MVC

## Функционал

- Создание заявок пользователями и отправка их в отделы/пользователям;
- Назначение ответственных и соисполнителей для заявок, руководителями отделов;
- Пересылка заявок в отделы;
- Генерация финансовых документов;
- Работа с документами, возможность отправить финансовые документы директору на согласование;
- Авторизация реализована через ESIA;

## Авторы
- **<a href="https://t.me/qiexd">Антипин Егор</a>** - *Программист*
- **<a href="https://t.me/sh4r1k">Попов Глеб</a>** - *Программист*

## Стек технологий

![C#](https://img.shields.io/badge/c%23-%23239120.svg?style=for-the-badge&logo=csharp&logoColor=white)
![.Net](https://img.shields.io/badge/.NET-5C2D91?style=for-the-badge&logo=.net&logoColor=white)
![Postgres](https://img.shields.io/badge/postgres-%23316192.svg?style=for-the-badge&logo=postgresql&logoColor=white)
![JavaScript](https://img.shields.io/badge/javascript-%23323330.svg?style=for-the-badge&logo=javascript&logoColor=%23F7DF1E)
![Bootstrap](https://img.shields.io/badge/bootstrap-%238511FA.svg?style=for-the-badge&logo=bootstrap&logoColor=white)

## Использованные библиотеки

- DinkToPdf [<a href="https://github.com/rdvojmoc/DinkToPdf">GIT</a>] - библиотека для конвертации HTML документов в PDF
- OpenXmlPower [<a href="https://github.com/sawcheg/OpenXmlPowerTools.NetCore">GIT</a>] - библиотека, использованная для конвертации из docx в HTML (в данный момент требуется интеграция данной функциональности в проект)
- EF Core

## Переменные среды
- DefaultConnectionPostgree - cтрока подключения к БД в appsettings.json

  `"DefaultConnectionPostgree": "Server=server;Port=5432;Database=miac_project;User Id=userId;Password=pass"`
## Развертывание
- Склонировать проект
- Изменить строку подключения к БД
- Проверить актуальность расположения и доступность API для авторизации через ESIA в Service/MIACAuthService.cs
- Провести первоначальную миграцию, для создания БД со стартовыми данными

  ```
  dotnet ef migrations add initial  
  dotnet ef database update
  ```
- Запустить тестовое API (при необходимости)
- Произвести запуск Tasker (по умолчанию localhost:10010)
## Структура проекта
- Api/NotifyController.cs - api контроллер, используемый для возврата количества непрочитанных заявок пользователю
- Data/InitialDbData.cs - статический класс, хранящий стартовые данные, которые буду созданы при первой миграции БД
- Documents/HTML - в этой папке находятся HTML файлы, используемые для конвертации в PDF
- Dto/AuthDto - в этой папке находятся классы, используемые при парсинге JSON ответов от API при авторизации через ESIA
- Interfaces/IDocument.cs - интерфейс, используемый при создании новых типов документов, которые можно будет генерировать. (пример использования в Models/FinancialTaskDocument.cs)
- Service/AuthService.cs - сервис, используемый для работы с сессиями, позволяющий узнавать информацию о текущем пользователе
- Service/DocumentsService.cs - сервис, используемый для работы с документами
- Service/MIACAuthService.cs - сервис, используемый при авторизации через ESIA или тестовое API
- appsettings.json - прописываем строку подключения к БД
- libwkhtmltox.* - файлы, используемые библиотекой DinkToPdf

## Известные баги 
- Не везде прописаны ограничения доступа к функциям по ролям и группа;
- group_admin может иметь права схожие с admin по отношению к заявкам;
- Заявки можно сделать прочитанными, только при открытии всех полученных заявок;
- Не удаляются роли пользователя в куки, если не закрыть браузер, из-за этого на Layout могут оставаться кнопки, к которым у пользователя нет доступа
  
*Временное решение проблемы - роли принудительно удаляются, если неавторизованный пользователь попадает на страницу авторизации (редирект по умолчанию)*

## Возможные проблемы (Ошибки можно отследить в консоли)
- Ошибка 500 при авторизации через ESIA, если нет доступа к API для авторизации через ESIA 
- Ошибка 500 при работе с БД, если ссылка подключения к БД некорректна или БД упало 
- Ошибки при работе контроллеров

Пример вывода ошибки в консоль:
`НазваниеController - Метод - ТекстОтловленнойОшибки`
